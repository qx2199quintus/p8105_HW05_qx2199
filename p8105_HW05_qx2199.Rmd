---
title: "p8105_HW05_qx2199"
output: html_document

---



```{r setup, include = FALSE}
library(tidyverse)
library(purrr)
knitr::opts_chunk$set(
  fig.width = 10,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
set.seed(1)
```


## Problem 1

Read in the data.

```{r}
homicide_df = 
  read_csv("./homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",
    )
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")
```


Let's look at this a bit

```{r}
aggregate_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )
```

Can I do a prop test for a single city?

```{r}
prop.test(
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved), 
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_total)) %>% 
  broom::tidy()
```

Try to iterate ........

```{r}
results_df = 
  aggregate_df %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)
```



```{r}
problem_1
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  labs( title = "proportions of unsolved homicides", x = "city", y = "proportion of unsolved homicides" )

problem_1
```





## Problem 2

import and tidy dataset


```{r}
problem_2_df = 
  tibble(files = list.files(path = "./data",full.names = TRUE)) %>% 
  mutate(file_contents = map(.x = files, ~read_csv(.x))) %>% 
  unnest(file_contents) %>% 
   pivot_longer(
    week_1:week_8,
    names_to = "week",
    names_prefix = "week_",
    values_to = "observations"
  ) %>% 
  mutate(files = str_replace(files, ".csv$", "")) %>% 
  mutate(files = str_replace(files, "con", "control"),
         files = str_replace(files, "exp", "experimental")) %>% 
  separate(files, into = c("arms_old", "id"), sep = "\\_") %>%   
  separate (arms_old,into=c("dot","data","arm"), sep ="/") %>%
  select(-dot,-data) %>% 
  mutate(id = as.numeric(id), arm = as.factor(arm), week = as.numeric(week)) %>% 
  relocate(arm, id)

problem_2_df
```

Make a spaghetti plot showing observations on each subject over time, and comment on differences between groups.

```{r}
problem_2_plot=
problem_2_df %>%
  ggplot(aes(x = week, y = observations, group = interaction(id,arm),color=arm))  +scale_color_manual(values=c("#6495ED","#FF9966"))+
  geom_line() + labs(  title = "Observations on each subject in experimental and control group ",x = "week", y = "observations")
problem_2_plot
```

Comment on differences between groups.

We found that at week 1,the observed values in the control group and the experimental group are similar. During the following weeks we can see that  there's an increasing trend in the observed values in the experimental group, while in the control group,the observed value varies between -2.5 and 5, and there's not a increasing/decreasing trend in terms of the observed values, and the trendseems to be relatively stable in the control group. We could see at the difference in the two groups become larger after 8 weeks. The overall observed values in the experimental group is higher than that in the control group after 8.

## Problem 3

```{r}
problem_3 = function(n = 30, mu, sigma = 5) 
  {
  sim_data = tibble(
    x = rnorm(n, mean = mu, sd = sigma)
  )
 sim_data %>% 
    summarize(
      mu_hat = mean(x),
      t.test(x, mu = 0, conf.level = 0.95) %>% broom::tidy() %>% 
      select(p.value)
    )
}

```




